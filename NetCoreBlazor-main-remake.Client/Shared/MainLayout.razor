@inherits LayoutComponentBase
@inject NetCoreBlazor_main_remake.Client.Services.AuthService AuthService
@inject NavigationManager Navigation
@inject NetCoreBlazor_main_remake.Client.Services.ThemeService ThemeService
@inject NetCoreBlazor_main_remake.Client.Services.LanguageService LanguageService

<div class="layout">
    <nav class="sidebar" style="@(!isLoggedIn ? "display:none" : "")">
        <h3>@T("panel")</h3>

        <ul>
            <li>
                <NavLink href="/home" class="nav-link" activeclassname="active">
                    @T("home")
                </NavLink>
            </li>

            <li>
                <NavLink href="/perfil" class="nav-link" activeclassname="active">
                    @T("perfil")
                </NavLink>
            </li>

            @if (rol == "Chef")
            {
                <li>
                    <NavLink href="/recetas" class="nav-link" activeclassname="active">
                        @T("recetas")
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/ingredientes" class="nav-link" activeclassname="active">
                        @T("ingredientes")
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/pasos" class="nav-link" activeclassname="active">
                        @T("pasos")
                    </NavLink>
                </li>
            }

            @if (rol == "Administrador")
            {
                <li>
                    <NavLink href="/tipo-ingredientes" class="nav-link" activeclassname="active">
                        @T("tipoIngredientes")
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/tipo-recetas" class="nav-link" activeclassname="active">
                        @T("tipoRecetas")
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/unida-de-medicion" class="nav-link" activeclassname="active">
                        @T("unidades")
                    </NavLink>
                </li>
                <li>
                    <NavLink href="/usuarios" class="nav-link" activeclassname="active">
                        @T("usuarios")
                    </NavLink>
                </li>
            }
        </ul>

        <button class="theme-button" @onclick="CambiarTema">
            @(ThemeService.CurrentTheme == "light"
                ? "üåô " + T("modoOscuro")
                : "‚òÄÔ∏è " + T("modoClaro"))
        </button>

        <button class="theme-button" @onclick="CambiarIdioma">
            @(LanguageService.CurrentLanguage == "es" ? "EN" : "ES")
        </button>

        <button @onclick="Logout" class="logout-button">
            @T("cerrarSesion")
        </button>
    </nav>

    <main class="content">
        @Body
    </main>
</div>

@code {
    private bool isLoggedIn;
    private string? rol;

    protected override async Task OnInitializedAsync()
    {
        await ThemeService.InitializeAsync();
        await LanguageService.InitializeAsync();

        await LoadAuthState();

        AuthService.OnChange += AuthStateChanged;
        ThemeService.OnChange += StateHasChanged;
        LanguageService.OnChange += StateHasChanged;
    }

    private string T(string key)
        => LanguageService.Translate(key);

    private async Task AuthStateChanged()
    {
        await LoadAuthState();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadAuthState()
    {
        isLoggedIn = await AuthService.IsLoggedInAsync();
        rol = isLoggedIn ? await AuthService.GetRoleAsync() : null;
    }

    private async Task CambiarTema()
    {
        await ThemeService.ToggleThemeAsync();
    }

    private async Task CambiarIdioma()
    {
        await LanguageService.ToggleLanguageAsync();
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        AuthService.OnChange -= AuthStateChanged;
        ThemeService.OnChange -= StateHasChanged;
        LanguageService.OnChange -= StateHasChanged;
    }
}
