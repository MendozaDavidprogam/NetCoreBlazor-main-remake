@page "/perfil"
@inject NetCoreBlazor_main_remake.Client.Services.AuthService AuthService
@inject NetCoreBlazor_main_remake.Client.Services.UsuarioService UsuarioService
@inject NavigationManager Navigation
@using NetCoreBlazor_main_remake.Client.Models
@using System.Text.Json
@using System.Text

<h2>Mi Perfil</h2>

@if (isLoading)
{
    <p>Cargando...</p>
}
else if (usuario != null)
{
    <EditForm Model="usuario" OnValidSubmit="ActualizarPerfil">
        <DataAnnotationsValidator />
        <div class="form-group">
            <label>Nombre</label>
            <InputText @bind-Value="usuario.Name" class="form-control" />
        </div>
        <div class="form-group">
            <label>Apellido</label>
            <InputText @bind-Value="usuario.Lastname" class="form-control" />
        </div>
        <div class="form-group">
            <label>Email</label>
            <InputText @bind-Value="usuario.Email" class="form-control" Disabled="true" />
        </div>
        <div class="form-group">
            <label>Role</label>
            <InputText @bind-Value="usuario.Role" class="form-control" Disabled="true" />
        </div>
        <div class="form-group">
            <label>Status</label>
            <InputText @bind-Value="usuario.Status" class="form-control" Disabled="true" />
        </div>

        <button type="submit" class="btn btn-primary mt-3">Actualizar</button>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="alert alert-info mt-2">@mensaje</div>
        }
    </EditForm>
}
else
{
    <div class="alert alert-danger">No se pudo cargar la información del usuario. Token inválido o expirado.</div>
}

@code {
    private UsuarioDTO? usuario;
    private bool isLoading = true;
    private string mensaje = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var loggedIn = await AuthService.IsLoggedInAsync();
        if (!loggedIn)
        {
            Navigation.NavigateTo("/");
            return;
        }

        var jwtToken = await AuthService.GetTokenAsync();
        if (string.IsNullOrEmpty(jwtToken))
        {
            Navigation.NavigateTo("/");
            return;
        }

        int userId = GetUserIdFromJwt(jwtToken);
        if (userId <= 0)
        {
            mensaje = "Usuario no válido o token expirado.";
            isLoading = false;
            return;
        }

        usuario = await UsuarioService.GetUsuarioAsync(userId);
        isLoading = false;
    }

    private async Task ActualizarPerfil()
    {
        if (usuario == null) return;

        var exito = await UsuarioService.ActualizarUsuarioAsync(usuario.Id, usuario.Name, usuario.Lastname);
        mensaje = exito ? "Perfil actualizado correctamente" : "Error al actualizar perfil";
    }

    private int GetUserIdFromJwt(string token)
    {
        try
        {
            var parts = token.Split('.');
            if (parts.Length != 3) return 0;

            var payload = parts[1];
            payload = payload.Replace('-', '+').Replace('_', '/');
            switch (payload.Length % 4)
            {
                case 2: payload += "=="; break;
                case 3: payload += "="; break;
            }

            var bytes = Convert.FromBase64String(payload);
            var json = Encoding.UTF8.GetString(bytes);
            var doc = JsonDocument.Parse(json);

            // buscar varias posibles propiedades
            if (doc.RootElement.TryGetProperty("id", out var idProp) ||
                doc.RootElement.TryGetProperty("userId", out idProp) ||
                doc.RootElement.TryGetProperty("sub", out idProp))
            {
                if (idProp.ValueKind == JsonValueKind.Number)
                    return idProp.GetInt32();
                if (idProp.ValueKind == JsonValueKind.String && int.TryParse(idProp.GetString(), out int parsedId))
                    return parsedId;
            }
        }
        catch
        {
            // ignorar errores
        }

        return 0;
    }
}
